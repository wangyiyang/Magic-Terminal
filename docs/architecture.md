# Magic Terminal æ¶æ„è®¾è®¡

## ğŸ—ï¸ æ€»ä½“æ¶æ„

Magic Terminal é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œå°†ç»ˆç«¯æ¨¡æ‹Ÿå™¨çš„å¤æ‚åŠŸèƒ½åˆ†è§£ä¸ºæ¸…æ™°çš„æ¨¡å—ï¼Œç¡®ä¿ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ç»ˆç«¯æ§åˆ¶å±‚ (Terminal Control Layer)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                è¾“å…¥è¾“å‡ºå±‚ (I/O Layer)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              å¹³å°æŠ½è±¡å±‚ (Platform Abstraction)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ æ ¸å¿ƒç»„ä»¶

### 1. ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)

#### ä¸»è¦ç»„ä»¶
- **ä¸»çª—å£ (Main Window)**: åº”ç”¨ç¨‹åºçš„ä¸»è¦å®¹å™¨
- **ç»ˆç«¯ç»„ä»¶ (Terminal Widget)**: æ ¸å¿ƒçš„ç»ˆç«¯æ˜¾ç¤ºç»„ä»¶
- **èœå•ç³»ç»Ÿ (Menu System)**: åº”ç”¨ç¨‹åºèœå•å’Œä¸Šä¸‹æ–‡èœå•
- **ä¸»é¢˜ç®¡ç† (Theme Manager)**: ç•Œé¢ä¸»é¢˜å’Œæ ·å¼ç®¡ç†

#### æŠ€æœ¯å®ç°
```go
// ä¸»è¦åŸºäº Fyne æ¡†æ¶
type TerminalApp struct {
    app      fyne.App
    window   fyne.Window
    terminal *Terminal
    theme    fyne.Theme
}
```

#### èŒè´£
- å¤„ç†ç”¨æˆ·äº¤äº’äº‹ä»¶
- ç®¡ç†çª—å£çŠ¶æ€å’Œå¸ƒå±€
- æä¾›é…ç½®ç•Œé¢
- å®ç°å¿«æ·é”®ç»‘å®š

### 2. ç»ˆç«¯æ§åˆ¶å±‚ (Terminal Control Layer)

#### æ ¸å¿ƒæ¨¡å—

##### Terminal æ ¸å¿ƒç±»
```go
type Terminal struct {
    widget.BaseWidget
    fyne.ShortcutHandler
    
    content      *widget2.TermGrid  // ç»ˆç«¯ç½‘æ ¼æ˜¾ç¤º
    config       Config             // ç»ˆç«¯é…ç½®
    pty          *os.File          // PTY æ–‡ä»¶æè¿°ç¬¦
    cmd          *exec.Cmd         // å­è¿›ç¨‹å‘½ä»¤
    
    // çŠ¶æ€ç®¡ç†
    cursor       Position          // å…‰æ ‡ä½ç½®
    cells        [][]Cell         // å­—ç¬¦ç½‘æ ¼
    colors       ColorScheme      // é¢œè‰²æ–¹æ¡ˆ
    
    // åŒæ­¥æ§åˆ¶
    listenerLock sync.Mutex       // ç›‘å¬å™¨é”
    writeLock    sync.Mutex       // å†™å…¥é”
}
```

##### é…ç½®ç®¡ç†
```go
type Config struct {
    Title         string        // ç»ˆç«¯æ ‡é¢˜
    Rows, Columns uint          // è¡Œåˆ—æ•°
    Shell         string        // é»˜è®¤Shell
    Colors        ColorScheme   // é¢œè‰²é…ç½®
    Font          FontConfig    // å­—ä½“é…ç½®
}
```

#### èŒè´£
- ç®¡ç†ç»ˆç«¯çŠ¶æ€å’Œé…ç½®
- å¤„ç†ç»ˆç«¯åè®®è§£æ
- åè°ƒè¾“å…¥è¾“å‡ºæµ
- ç»´æŠ¤å…‰æ ‡å’Œæ˜¾ç¤ºçŠ¶æ€

### 3. è¾“å…¥è¾“å‡ºå±‚ (I/O Layer)

#### è¾“å…¥å¤„ç†æ¨¡å—

##### é”®ç›˜è¾“å…¥ (input.go)
```go
type InputHandler struct {
    terminal *Terminal
    buffer   []byte
}

// ä¸»è¦åŠŸèƒ½
- é”®ç›˜äº‹ä»¶å¤„ç†
- å¿«æ·é”®æ˜ å°„
- è¾“å…¥ç¼“å†²ç®¡ç†
- ç‰¹æ®Šé”®åºåˆ—è½¬æ¢
```

##### é¼ æ ‡è¾“å…¥ (mouse.go)
```go
type MouseHandler struct {
    terminal *Terminal
    mode     MouseMode
}

// åŠŸèƒ½ç‰¹æ€§
- é¼ æ ‡ç‚¹å‡»å®šä½
- æ–‡æœ¬é€‰æ‹©
- æ»šè½®æ”¯æŒ
- å³é”®èœå•
```

#### è¾“å‡ºå¤„ç†æ¨¡å—

##### æ–‡æœ¬æ¸²æŸ“ (render.go)
```go
type Renderer struct {
    terminal *Terminal
    cache    *RenderCache
}

// æ¸²æŸ“åŠŸèƒ½
- å­—ç¬¦ç½‘æ ¼æ¸²æŸ“
- é¢œè‰²å¤„ç†
- å­—ä½“æ¸²æŸ“
- æ€§èƒ½ä¼˜åŒ–
```

##### ç»ˆç«¯åè®® (escape.go, osc.go, apc.go)
```go
// ANSI è½¬ä¹‰åºåˆ—å¤„ç†
type EscapeHandler struct {
    terminal *Terminal
    parser   *ANSIParser
}

// æ”¯æŒçš„åè®®
- VT100/VT220 è½¬ä¹‰åºåˆ—
- ANSI é¢œè‰²ä»£ç 
- OSC (Operating System Command)
- APC (Application Program Command)
```

### 4. å¹³å°æŠ½è±¡å±‚ (Platform Abstraction)

#### å¹³å°ç‰¹å®šå®ç°

##### Unix ç³»ç»Ÿ (term_unix.go)
```go
// Unix å¹³å°å®ç°
func (t *Terminal) startPTY() error {
    // ä½¿ç”¨ github.com/creack/pty
    pty, tty, err := pty.Open()
    // PTY é…ç½®å’Œç®¡ç†
}
```

##### Windows ç³»ç»Ÿ (term_windows.go)
```go
// Windows å¹³å°å®ç°  
func (t *Terminal) startConPTY() error {
    // ä½¿ç”¨ ConPTY API
    // Windows ç‰¹å®šçš„ç»ˆç«¯å¤„ç†
}
```

#### èŒè´£
- æŠ½è±¡å¹³å°å·®å¼‚
- æä¾›ç»Ÿä¸€çš„ PTY æ¥å£
- å¤„ç†å¹³å°ç‰¹å®šçš„ç»ˆç«¯ç‰¹æ€§

## ğŸ”„ æ•°æ®æµæ¶æ„

### è¾“å…¥æ•°æ®æµ
```
ç”¨æˆ·è¾“å…¥ â†’ è¾“å…¥å¤„ç†å™¨ â†’ åè®®è½¬æ¢ â†’ PTY â†’ Shellè¿›ç¨‹
    â†“
é”®ç›˜/é¼ æ ‡äº‹ä»¶ â†’ äº‹ä»¶åˆ†å‘ â†’ å‘½ä»¤è§£æ â†’ è¿›ç¨‹é€šä¿¡
```

### è¾“å‡ºæ•°æ®æµ
```
Shellè¿›ç¨‹ â†’ PTY â†’ æ•°æ®ç¼“å†² â†’ åè®®è§£æ â†’ æ¸²æŸ“å¼•æ“ â†’ å±å¹•æ˜¾ç¤º
    â†“
æ–‡æœ¬è¾“å‡º â†’ è½¬ä¹‰åºåˆ— â†’ å­—ç¬¦ç½‘æ ¼ â†’ è§†è§‰æ¸²æŸ“ â†’ ç”¨æˆ·ç•Œé¢
```

### é…ç½®æ•°æ®æµ
```
é…ç½®æ–‡ä»¶ â†’ é…ç½®è§£æ â†’ çŠ¶æ€ç®¡ç† â†’ ç»„ä»¶æ›´æ–° â†’ ç•Œé¢åˆ·æ–°
    â†“
ç”¨æˆ·è®¾ç½® â†’ éªŒè¯æ£€æŸ¥ â†’ æŒä¹…åŒ–å­˜å‚¨ â†’ å®æ—¶åº”ç”¨
```

## ğŸ§© æ¨¡å—é—´äº¤äº’

### æ ¸å¿ƒäº¤äº’æ¨¡å¼

#### 1. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)
```go
// é…ç½®å˜åŒ–ç›‘å¬
type ConfigListener chan Config

func (t *Terminal) AddListener(listener ConfigListener) {
    t.listenerLock.Lock()
    defer t.listenerLock.Unlock()
    t.listeners = append(t.listeners, listener)
}
```

#### 2. å‘½ä»¤æ¨¡å¼ (Command Pattern)
```go
// ç»ˆç«¯å‘½ä»¤å¤„ç†
type TerminalCommand interface {
    Execute(terminal *Terminal) error
}

type EscapeCommand struct {
    sequence string
    handler  EscapeHandler
}
```

#### 3. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
```go
// å¹³å°ç‰¹å®šç­–ç•¥
type PlatformStrategy interface {
    CreatePTY() (PTY, error)
    ConfigureTerminal(config Config) error
}
```

## ğŸ† è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)
- æ¯ä¸ªæ¨¡å—ä¸“æ³¨äºå•ä¸€åŠŸèƒ½
- æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ
- é™ä½è€¦åˆåº¦

### 2. å¼€é—­åŸåˆ™ (OCP)
- å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- é€šè¿‡æ¥å£å’ŒæŠ½è±¡æ”¯æŒæ–°åŠŸèƒ½
- æ’ä»¶åŒ–æ¶æ„å‡†å¤‡

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
- ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- å¹³å°æŠ½è±¡å±‚è®¾è®¡
- æ¥å£ä¼˜å…ˆçš„è®¾è®¡æ–¹æ³•

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)
- ç»†ç²’åº¦çš„æ¥å£è®¾è®¡
- é¿å…è‡ƒè‚¿çš„æ¥å£
- å®¢æˆ·ç«¯åªä¾èµ–éœ€è¦çš„æ¥å£

## ğŸ”§ å…³é”®è®¾è®¡å†³ç­–

### 1. é€‰æ‹© Fyne æ¡†æ¶
**åŸå› :**
- è·¨å¹³å°æ”¯æŒä¼˜ç§€
- Go è¯­è¨€åŸç”Ÿæ”¯æŒ
- ç°ä»£åŒ–çš„ UI è®¾è®¡
- æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ

**æƒè¡¡:**
- ç›¸å¯¹è¾ƒæ–°çš„æ¡†æ¶
- ç”Ÿæ€ç³»ç»Ÿä»åœ¨å‘å±•
- æŸäº›é«˜çº§åŠŸèƒ½éœ€è¦è‡ªå®ç°

### 2. åˆ†å±‚æ¶æ„è®¾è®¡
**ä¼˜åŠ¿:**
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- æ”¯æŒç‹¬ç«‹æ¼”è¿›
- ä¾¿äºæ–°åŠŸèƒ½æ·»åŠ 

**è€ƒè™‘:**
- å¢åŠ äº†ä¸€å®šçš„å¤æ‚æ€§
- éœ€è¦è‰¯å¥½çš„æ¥å£è®¾è®¡
- å±‚é—´é€šä¿¡éœ€è¦ä¼˜åŒ–

### 3. å¼‚æ­¥ I/O å¤„ç†
**å®ç°:**
```go
// å¼‚æ­¥è¯»å– PTY è¾“å‡º
go func() {
    buffer := make([]byte, bufLen)
    for {
        n, err := t.pty.Read(buffer)
        if err != nil {
            return
        }
        t.processOutput(buffer[:n])
    }
}()
```

**ä¼˜åŠ¿:**
- å“åº”å¼ç”¨æˆ·ä½“éªŒ
- é¿å…ç•Œé¢é˜»å¡
- æ›´å¥½çš„æ€§èƒ½è¡¨ç°

## ğŸ“Š æ€§èƒ½æ¶æ„

### 1. æ¸²æŸ“ä¼˜åŒ–
- **åŒç¼“å†²æ¸²æŸ“**: é¿å…é—ªçƒ
- **å¢é‡æ›´æ–°**: åªæ¸²æŸ“å˜åŒ–éƒ¨åˆ†
- **ç¼“å­˜æœºåˆ¶**: å­—ç¬¦å’Œé¢œè‰²ç¼“å­˜

### 2. å†…å­˜ç®¡ç†
- **å¯¹è±¡æ± **: å¤ç”¨é¢‘ç¹åˆ›å»ºçš„å¯¹è±¡
- **åƒåœ¾å›æ”¶ä¼˜åŒ–**: å‡å°‘ GC å‹åŠ›
- **ç¼“å†²åŒºç®¡ç†**: æ™ºèƒ½çš„ç¼“å†²åŒºå¤§å°è°ƒæ•´

### 3. å¹¶å‘æ§åˆ¶
- **è¯»å†™é”**: ä¿æŠ¤å…±äº«æ•°æ®ç»“æ„
- **é€šé“é€šä¿¡**: åç¨‹é—´å®‰å…¨é€šä¿¡
- **åŸå­æ“ä½œ**: é«˜æ€§èƒ½çš„çŠ¶æ€æ›´æ–°

## ğŸ”® æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶ç³»ç»Ÿå‡†å¤‡
```go
// é¢„ç•™çš„æ’ä»¶æ¥å£
type Plugin interface {
    Name() string
    Initialize(terminal *Terminal) error
    HandleCommand(cmd string) (bool, error)
}
```

### 2. ä¸»é¢˜ç³»ç»Ÿ
```go
// å¯æ‰©å±•çš„ä¸»é¢˜ç³»ç»Ÿ
type Theme interface {
    Colors() ColorScheme
    Fonts() FontConfig
    Layout() LayoutConfig
}
```

### 3. åè®®æ‰©å±•
```go
// æ”¯æŒæ–°åè®®çš„æ‰©å±•ç‚¹
type ProtocolHandler interface {
    CanHandle(data []byte) bool
    Process(data []byte) error
}
```

---

æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒï¼š
- [æ¨¡å—è®¾è®¡](./module-design.md)
- [API æ–‡æ¡£](./api-reference.md)
- [æ€§èƒ½ä¼˜åŒ–](./performance-optimization.md)
